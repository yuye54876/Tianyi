---
import { Icon } from "astro-icon/components";
import PhotoCard from "@/components/pages/gallery/PhotoCard.astro";
import { galleryConfig, siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { getAlbumCover, scanAlbumPhotos } from "@/utils/gallery-utils";

// 检查页面是否启用
if (!siteConfig.pages.gallery) {
	return Astro.redirect("/404/");
}

export function getStaticPaths() {
	return galleryConfig.albums.map((album) => ({
		params: { album: album.id },
	}));
}

const { album: albumId } = Astro.params;
const albumMeta = galleryConfig.albums.find((a) => a.id === albumId);

if (!albumMeta) {
	return Astro.redirect("/404/");
}

const photos = scanAlbumPhotos(albumMeta.id);
const cover = getAlbumCover(albumMeta, photos);
const columnWidth = galleryConfig.columnWidth || 240;
---

<MainGridLayout title={albumMeta.name} description={albumMeta.description || ""}>
  <!-- 相册封面横幅 -->
  <div class="w-full rounded-(--radius-large) overflow-hidden relative">
    {cover ? (
      <div class="relative w-full aspect-[3/1] min-h-[200px] max-h-[360px]">
        <img
          src={cover}
          alt={albumMeta.name}
          class="w-full h-full object-cover"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent" />
        <!-- 返回按钮 -->
        <a
          href="/gallery/"
          class="absolute top-4 left-4 inline-flex items-center gap-1.5 text-sm text-white/90 hover:text-white bg-black/30 hover:bg-black/50 backdrop-blur-sm px-3 py-1.5 rounded-lg transition-colors"
        >
          <Icon name="material-symbols:arrow-back" class="text-base" />
          {i18n(I18nKey.galleryBackToAlbums)}
        </a>
        <!-- 封面上的信息 -->
        <div class="absolute bottom-0 left-0 right-0 p-6">
          <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2 drop-shadow-lg">
            {albumMeta.name}
          </h1>
          {albumMeta.description && (
            <p class="text-sm text-white/75 leading-relaxed mb-2 max-w-2xl line-clamp-2">
              {albumMeta.description}
            </p>
          )}
          <div class="flex items-center gap-4 text-sm text-white/80 flex-wrap">
            {albumMeta.date && (
              <span class="inline-flex items-center gap-1">
                <Icon name="material-symbols:calendar-today" class="text-sm" />
                {albumMeta.date}
              </span>
            )}
            {albumMeta.location && (
              <span class="inline-flex items-center gap-1">
                <Icon name="material-symbols:location-on" class="text-sm" />
                {albumMeta.location}
              </span>
            )}
            <span class="inline-flex items-center gap-1">
              <Icon name="material-symbols:photo-library" class="text-sm" />
              {photos.length} {i18n(I18nKey.galleryPhotos)}
            </span>
          </div>
          {albumMeta.tags && albumMeta.tags.length > 0 && (
            <div class="flex flex-wrap gap-1.5 mt-2.5">
              {albumMeta.tags.map((tag) => (
                <span class="text-xs px-2 py-0.5 rounded bg-white/20 text-white/90 backdrop-blur-sm">
                  {tag}
                </span>
              ))}
            </div>
          )}
        </div>
      </div>
    ) : (
      <div class="card-base px-6 py-4">
        <a
          href="/gallery/"
          class="inline-flex items-center gap-1 text-sm text-(--primary) hover:underline mb-3"
        >
          <Icon name="material-symbols:arrow-back" class="text-base" />
          {i18n(I18nKey.galleryBackToAlbums)}
        </a>
        <h1 class="text-2xl sm:text-3xl font-bold text-neutral-900 dark:text-neutral-100">
          {albumMeta.name}
        </h1>
        <div class="flex items-center gap-4 text-sm text-neutral-500 dark:text-neutral-400 mt-2 flex-wrap">
          {albumMeta.date && (
            <span class="inline-flex items-center gap-1">
              <Icon name="material-symbols:calendar-today" class="text-sm" />
              {albumMeta.date}
            </span>
          )}
          {albumMeta.location && (
            <span class="inline-flex items-center gap-1">
              <Icon name="material-symbols:location-on" class="text-sm" />
              {albumMeta.location}
            </span>
          )}
          <span>{photos.length} {i18n(I18nKey.galleryPhotos)}</span>
        </div>
      </div>
    )}
  </div>

  <!-- 瀑布流照片网格 -->
  <div class="w-full rounded-(--radius-large) overflow-hidden relative mt-4">
    <div class="card-base z-10 px-6 py-6 relative w-full">
      {photos.length > 0 ? (
        <div
          class="gallery-masonry"
          style={`--col-width: ${columnWidth}px;`}
        >
          {photos.map((photo) => (
            <PhotoCard src={photo} albumId={albumMeta.id} />
          ))}
        </div>
      ) : (
        <div class="flex flex-col items-center justify-center py-16 text-neutral-400 dark:text-neutral-500">
          <Icon name="material-symbols:photo-library" class="text-6xl mb-4 opacity-50" />
          <p class="text-lg">{i18n(I18nKey.galleryNoAlbums)}</p>
        </div>
      )}
    </div>
  </div>

  <style is:global>
    .gallery-masonry {
      column-width: var(--col-width, 240px);
      column-gap: 0.75rem;
    }

    .gallery-masonry .gallery-photo-card {
      break-inside: avoid;
    }
  </style>
</MainGridLayout>
