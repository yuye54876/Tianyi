---
import { Icon } from "astro-icon/components";
import AlbumCard from "@/components/pages/gallery/AlbumCard.astro";
import { galleryConfig, siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import { getAlbumCover, scanAlbumPhotos } from "@/utils/gallery-utils";

// 检查页面是否启用
if (!siteConfig.pages.gallery) {
	return Astro.redirect("/404/");
}

const title = i18n(I18nKey.gallery);
const description = i18n(I18nKey.galleryDescription);

// 构建相册数据（扫描照片、获取封面）
const albums = galleryConfig.albums.map((album) => {
	const photos = scanAlbumPhotos(album.id);
	const cover = getAlbumCover(album, photos);
	return { ...album, cover, photoCount: photos.length };
});

// 收集所有标签用于筛选
const allTags = [...new Set(albums.flatMap((a) => a.tags || []))].sort();
---

<MainGridLayout title={title} description={description}>
  <div
    class="flex w-full rounded-(--radius-large) overflow-hidden relative min-h-32"
  >
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 页面标题和描述 -->
      <div class="mb-4">
        <div class="flex items-center gap-3 mb-3">
          <div
            class="h-8 w-8 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70"
          >
            <Icon name="material-symbols:photo-library" class="text-[1.5rem]" />
          </div>
          <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
            {title}
          </h1>
        </div>
        {description && (
          <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed mb-4">
            {description}
          </p>
        )}
      </div>

      <!-- 标签筛选 -->
      {albums.length > 0 && allTags.length > 0 && (
        <gallery-filter class="flex flex-wrap gap-2 mb-6">
          <button
            data-tag="all"
            class="btn-regular px-3 py-1.5 rounded-lg bg-(--primary) text-white hover:bg-(--primary) transition-colors duration-200 text-sm font-medium"
          >
            {i18n(I18nKey.all)}
          </button>
          {allTags.map((tag) => (
            <button
              data-tag={tag}
              class="btn-regular px-3 py-1.5 rounded-lg bg-(--btn-regular-bg) text-(--btn-content) hover:bg-(--btn-regular-bg-hover) transition-colors duration-200 text-sm font-medium"
            >
              {tag}
            </button>
          ))}
        </gallery-filter>
      )}

      <!-- 相册卡片网格 -->
      {albums.length > 0 ? (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 my-4">
          {albums.map((album) => (
            <AlbumCard
              id={album.id}
              name={album.name}
              cover={album.cover}
              description={album.description}
              date={album.date}
              location={album.location}
              tags={album.tags}
              photoCount={album.photoCount}
            />
          ))}
        </div>
      ) : (
        <div class="flex flex-col items-center justify-center py-16 text-neutral-400 dark:text-neutral-500">
          <Icon name="material-symbols:photo-library" class="text-6xl mb-4 opacity-50" />
          <p class="text-lg">{i18n(I18nKey.galleryNoAlbums)}</p>
        </div>
      )}
    </div>
  </div>

  <script slot="head" is:inline>
    if (!customElements.get("gallery-filter")) {
      class GalleryFilter extends HTMLElement {
        constructor() {
          super();
        }

        connectedCallback() {
          this.addEventListener("click", this.handleClick);
        }

        disconnectedCallback() {
          this.removeEventListener("click", this.handleClick);
        }

        handleClick(e) {
          const target = e.target;
          const button = target.closest("button");
          if (!button) return;

          const selectedTag = button.dataset.tag;
          const filters = this.querySelectorAll("button");
          const container = this.closest(".card-base");
          if (!container) return;

          const cards = container.querySelectorAll(".album-card");

          filters.forEach((f) => {
            f.classList.remove("bg-(--primary)", "text-white");
            f.classList.remove("hover:bg-(--primary)");
            f.classList.add(
              "bg-(--btn-regular-bg)",
              "text-(--btn-content)"
            );
            f.classList.add("hover:bg-(--btn-regular-bg-hover)");

            if (f === button) {
              f.classList.remove(
                "bg-(--btn-regular-bg)",
                "text-(--btn-content)"
              );
              f.classList.remove("hover:bg-(--btn-regular-bg-hover)");
              f.classList.add("bg-(--primary)", "text-white");
              f.classList.add("hover:bg-(--primary)");
            }
          });

          cards.forEach((card) => {
            const cardEl = card;
            const tags = (cardEl.dataset.tags || "").split(",");
            if (
              selectedTag === "all" ||
              (selectedTag && tags.includes(selectedTag))
            ) {
              cardEl.style.display = "";
              cardEl.classList.add("animate-fade-in-up");
            } else {
              cardEl.style.display = "none";
              cardEl.classList.remove("animate-fade-in-up");
            }
          });
        }
      }
      customElements.define("gallery-filter", GalleryFilter);
    }
  </script>
</MainGridLayout>
